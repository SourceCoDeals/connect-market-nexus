# Marketplace Listing & Landing Page Deep Audit (V2)

**Date:** February 28, 2026
**Scope:** Full-stack audit of deal-to-listing pipeline, landing page system, signup funnel, analytics, and backend infrastructure
**Predecessor:** MARKETPLACE_LISTING_AUDIT.md (V1 — 20 gaps identified & patched)

---

## Executive Summary

This second-pass audit goes deeper than V1, verifying the fixes from the first round and uncovering **structural issues** that V1 patches could not address. While V1 added the right code in the right places, several critical data-flow problems mean that **landing page content fields are never actually saved to the database** — the data is generated by the anonymizer and AI, passed to the form, then silently dropped before the DB insert. Additionally, the page_views tracking insert references columns that don't exist on the table, and signup deal-attribution writes to a field that doesn't exist on the profiles table.

**Bottom line:** The landing pages will render mostly empty content sections until the pipeline is fixed end-to-end.

---

## Severity Levels

| Level | Meaning |
|-------|---------|
| **P0** | Data is silently lost or feature is broken — users/admins won't know |
| **P1** | Feature exists but doesn't work as intended — visible gaps |
| **P2** | Missing functionality that impacts completeness |
| **P3** | Code quality, dead code, or UX friction |

---

## P0 — CRITICAL: Data Silently Lost

### GAP A: Landing page content fields dropped on listing creation

**The core problem:** The anonymizer (`deal-to-listing-anonymizer.ts`) generates 12 landing page content fields. `CreateListingFromDeal.tsx` passes them to the form. But the Zod form schema in `ImprovedListingEditor.tsx` does not define these fields, so they are **stripped during validation**. Even if they survived validation, `useRobustListingCreation.ts` has a hardcoded `DatabaseListingInsert` interface that does not include them — they would be dropped at the DB insert layer too.

**Fields affected (all silently lost):**
| Field | Exists on listings table? | In form schema? | In DB insert? |
|-------|--------------------------|-----------------|---------------|
| `investment_thesis` | YES | NO | NO |
| `custom_sections` | YES (JSONB) | NO | NO |
| `services` | YES | NO | NO |
| `growth_drivers` | YES (Json) | NO | NO |
| `competitive_position` | YES | NO | NO |
| `ownership_structure` | YES | NO | NO |
| `seller_motivation` | YES | NO | NO |
| `business_model` | YES | NO | NO |
| `customer_geography` | YES | NO | NO |
| `customer_types` | YES | NO | NO |
| `revenue_model` | YES | NO | NO |
| `end_market_description` | YES | NO | NO |

**Impact:** The landing page `ContentSections.tsx` renders `investment_thesis`, `custom_sections`, `services`, `ownership_structure`, and `seller_motivation` — but these will all be null because they were never saved. Landing pages will show only the hero description and metrics, with empty content body.

**Files to fix:**
1. `src/components/admin/ImprovedListingEditor.tsx` — Add fields to Zod schema (lines 22-78)
2. `src/hooks/admin/listings/use-robust-listing-creation.ts` — Add fields to `DatabaseListingInsert` interface and insert object (lines 27-186)
3. Need editor UI sections for these fields (or at minimum, pass-through support)

---

### GAP B: page_views insert uses non-existent columns

**File:** `src/pages/DealLandingPage/index.tsx` (lines 38-49)

**The problem:** The insert includes `event_type` and `event_data` fields:
```typescript
supabase.from('page_views').insert({
  session_id: sessionId,
  page_path: `/deals/${id}`,
  page_title: deal.title,
  event_type: 'landing_page_view',     // ← NOT IN SCHEMA
  event_data: {                          // ← NOT IN SCHEMA
    listing_id: id,
    deal_title: deal.title,
    source: 'deal_landing_page',
    referrer: document.referrer || null,
  },
})
```

**page_views schema (from types.ts lines 9451-9504):**
- `id`, `session_id`, `page_path`, `page_title`, `referrer`, `scroll_depth`, `time_on_page`, `exit_page`, `user_id`, `utm_*` fields, `created_at`
- **NO `event_type`** column
- **NO `event_data`** column

**Impact:** Supabase will reject the insert (extra fields not in schema). The `.catch(() => {})` silently swallows the error. **Zero landing page views are being recorded.**

**Fix:** Remove `event_type` and `event_data`, use the existing `referrer` field:
```typescript
supabase.from('page_views').insert({
  session_id: sessionId,
  page_path: `/deals/${id}`,
  page_title: deal.title,
  referrer: document.referrer || null,
})
```

---

### GAP C: Signup deal-attribution writes to non-existent field

**File:** `src/pages/Signup/useSignupSubmit.ts` (lines 70-82)

**The problem:** Code sets `(signupData as any).signup_metadata` but there is no `signup_metadata` column on the `profiles` table. The field is cast with `as any` to bypass TypeScript.

```typescript
(signupData as any).signup_metadata = {
  from_deal_id: dealContext.from_deal_id,
  first_deal_viewed: dealContext.first_deal_viewed,
  is_landing_page_referral: dealContext.is_landing_page_referral,
};
```

**Profiles table:** Confirmed via types.ts search — no `signup_metadata`, `from_deal_id`, or `first_deal_viewed` columns exist.

**Impact:** All deal attribution data from the landing page → signup funnel is silently lost. Admin cannot track which deals drove signups.

**Fix options:**
1. Add `signup_metadata JSONB` column to profiles table via migration
2. OR use `referral_source_detail` (exists) to encode deal context as JSON string
3. OR store in a separate `signup_events` tracking table

---

### GAP D: LandingPageAnalytics shows zero views (depends on GAP B)

**File:** `src/components/admin/LandingPageAnalytics.tsx`

The analytics component queries `page_views` where `page_path = /deals/{listingId}`. Since GAP B means zero views are recorded, this will always show 0 views / 0% conversion. Additionally, the component is **never rendered anywhere** — it's defined but not imported into any admin page.

**Impact:** Admins have no visibility into landing page performance.

**Fix:**
1. Fix GAP B first (page_views inserts)
2. Integrate component into admin listing detail view or AdminListingCard

---

## P1 — BROKEN BEHAVIOR

### GAP E: AI-generated content has no persistence path

**File:** `src/hooks/admin/listings/use-generate-listing-content.ts`

The `useGenerateListingContent` hook calls the `generate-listing-content` edge function and uses `form.setValue()` to populate editor fields. However:
- The AI generates `investment_thesis`, `custom_sections`, `services`, `growth_drivers`, etc.
- `form.setValue()` calls for these fields are no-ops because they're not in the Zod schema
- Even the fields that ARE in the schema (title, description, hero_description) work, but landing page content is lost

**Impact:** "Generate All with AI" button appears to work (title/description update) but landing page content sections remain empty.

---

### GAP F: Calendar URL always defaults to CEO's personal link

**Files:**
- `src/pages/DealLandingPage/components/DealSidebar.tsx` (line 40)
- `src/pages/DealLandingPage/components/DealRequestForm.tsx` (line 85)

Even when a different admin is the deal presenter, the calendar URL defaults to `DEFAULT_PRESENTER.calendarUrl` (Tomos Mughan's TidyCal). The `profiles` table doesn't have a `calendar_url` column, so there's no way to fetch presenter-specific calendar links.

**DealRequestForm** has a completely hardcoded calendar URL on line 85 that doesn't even reference the presenter query.

**Impact:** All "Schedule Buyer Call" buttons go to the same person regardless of who presents the deal.

**Fix:** Add `calendar_url` column to profiles OR add it to the deal sidebar props from the listing.

---

### GAP G: `useUpdateListing` spreads all fields without filtering

**File:** `src/hooks/admin/listings/use-update-listing.ts` (line 39)

```typescript
const { data, error } = await supabase
  .from('listings')
  .update({
    ...listing,
    updated_at: new Date().toISOString(),
  } as any)
  .eq('id', id)
```

This spreads `listing` directly into the update. Since `listing` comes from the form (which strips landing page fields), editing a listing and saving will **not overwrite** landing page content (fields simply won't be in the spread). This is actually a lucky accident — but it means there's no way to edit landing page content through the UI even if the fields were saved initially.

---

## P2 — MISSING FUNCTIONALITY

### GAP H: No editor sections for landing page content

The `ImprovedListingEditor` has 6 active sections (TopBar, Financial, Description, HeroDescription, Visuals, Internal). None of these allow editing:
- Investment thesis
- Custom sections (the main landing page content blocks)
- Services list
- Growth drivers
- Ownership structure / seller motivation
- Business model / customer geography / revenue model

There are 9 unused/legacy editor section components that could potentially be repurposed, but they're currently dead code:
- `EditorAdvancedSection.tsx`
- `EditorBasicInfoSection.tsx`
- `EditorBuyerVisibilitySection.tsx`
- `EditorCoreDetailsSection.tsx`
- `EditorFinancialAndMetricsSection.tsx`
- `EditorFinancialSection.tsx`
- `EditorInternalDataSection.tsx`
- `EditorInternalSection.tsx`
- `EditorMetricsSection.tsx`

---

### GAP I: EditorLivePreview component exists but is never rendered

**File:** `src/components/admin/editor-sections/EditorLivePreview.tsx`

This component calculates a quality score and shows a live preview card. It's fully built but never imported or rendered in the editor. Admins can't see how their listing will look before publishing.

---

### GAP J: No duplicate view protection on landing page

**File:** `src/pages/DealLandingPage/index.tsx`

The `hasTrackedView` ref prevents duplicate tracking within a single component mount, but:
- Browser refresh = new mount = new view recorded
- No session-level deduplication (same session_id + page_path combo)
- No IP-based or fingerprint-based deduplication

This will inflate view counts significantly.

**Fix:** Add a unique constraint or upsert on `(session_id, page_path)` in the page_views table, or check sessionStorage before inserting.

---

### GAP K: Email capture form — no phone or name collection

**File:** `src/pages/DealLandingPage/components/EmailCapture.tsx`

The email capture inserts into `connection_requests` with `lead_name: ''` and no phone. This creates low-quality leads that are harder for the sales team to follow up on.

**Impact:** Email-only leads have much lower contact rates.

**Recommendation:** Consider adding an optional name field, or at minimum populate `lead_name` with the email prefix.

---

### GAP L: Marketplace signup links point to external domain

**Files:** Multiple components (LandingHeader, DealSidebar, DealRequestForm, RelatedDeals)

All marketplace signup CTAs point to `https://marketplace.sourcecodeals.com/signup`. If the marketplace IS this app (the `/signup` route exists at the same domain), these links force unnecessary domain transitions and lose session context.

If the app serves both the landing page and the marketplace, links should be relative (`/signup`) with UTM params, not absolute external links. The `from_deal` URL param set by the signup page would then work correctly.

---

### GAP M: Visible-to-buyer-types label is inverted

**File:** `src/components/admin/editor-sections/EditorInternalCard.tsx`

The UI labels the buyer types control as "Hide From" but the underlying field `visible_to_buyer_types` stores which types CAN see the listing. If an admin checks "Private Equity" thinking "hide from PE", they're actually making it ONLY visible to PE.

---

## P3 — CODE QUALITY & DEAD CODE

### GAP N: 9 dead editor section components

Files listed in GAP H above. These are imported nowhere and add ~2,000 lines of dead code.

### GAP O: `ListingForm` wrapper is a pass-through

**File:** `src/components/admin/ListingForm.tsx`

This component simply forwards all props to `ImprovedListingEditor`. It adds no logic. Should be removed and callers should use `ImprovedListingEditor` directly.

### GAP P: Unsafe type casting in editor

**File:** `src/components/admin/ImprovedListingEditor.tsx` (line ~227)

```typescript
const formForSections = form as unknown as UseFormReturn<any>;
```

Double cast through `unknown` to `any` indicates a type architecture problem. Editor sections accept `UseFormReturn<any>` instead of the actual form type.

### GAP Q: `address_city` and `main_contact_*` fetched but unused

**File:** `src/pages/admin/CreateListingFromDeal.tsx`

The query fetches `address_city`, `main_contact_name`, `main_contact_email`, `main_contact_phone`, `main_contact_title` from the deal but never passes them to the anonymizer or form.

### GAP R: `ebitda_margin` fetched from deal but should be calculated

**File:** `src/pages/admin/CreateListingFromDeal.tsx`

The query fetches `ebitda_margin` directly from the deal, but the anonymizer calculates it from `ebitda/revenue*100`. The fetched value is ignored. Not a bug, but wastes a DB column read.

### GAP S: Anonymizer title generation only has 3 templates

**File:** `src/lib/deal-to-listing-anonymizer.ts`

With only 3 title patterns (revenue-anchored, margin-anchored, years-anchored), similar deals get formulaic titles. Should have more variation or use AI generation as primary.

### GAP T: Anonymizer phone regex misses international formats

**File:** `src/lib/deal-to-listing-anonymizer.ts`

The phone stripping regex targets US formats only. International numbers (UK: `+44 20 7946 0958`, Australian: `+61 2 1234 5678`) pass through anonymization.

---

## Data Flow Diagram (Current State)

```
DEAL ENRICHMENT                    LISTING CREATION                    LANDING PAGE
═══════════════                    ════════════════                    ════════════

enrich-deal/                       CreateListingFromDeal.tsx           /deals/:id
  ├─ transcripts (Gemini)            │                                   │
  ├─ website scrape (Firecrawl)      ├─ Fetches 40+ deal fields          ├─ useDealLandingPage
  ├─ LinkedIn enrichment             │                                   │  queries 41 listing fields
  ├─ Google Reviews                  ├─ anonymizeDealToListing()         │
  └─ AI extraction                   │  generates 30+ fields             ├─ DealHero (title, hero_desc, location)
                                     │  including 12 LP content fields   ├─ MetricsStrip (rev, ebitda, custom metrics)
                                     │                                   ├─ ContentSections ← EMPTY (no data saved)
                                     ├─ ImprovedListingEditor            ├─ DealRequestForm → connection_requests
                                     │  Zod schema: 30 fields            ├─ DealSidebar (presenter, exec summary)
                                     │  ❌ MISSING: 12 LP fields         ├─ RelatedDeals (3 other listings)
                                     │                                   ├─ EmailCapture → connection_requests
                                     ├─ useRobustListingCreation         └─ page_views insert ← ❌ FAILS (bad columns)
                                     │  DatabaseListingInsert: 30 fields
                                     │  ❌ MISSING: 12 LP fields
                                     │
                                     └─ Supabase listings table
                                        Has ALL columns needed
                                        But LP fields always NULL
```

---

## Priority Fix Order

| Priority | Gap | Issue | Effort |
|----------|-----|-------|--------|
| **1** | A | Add 12 LP fields to form schema + DB insert | Medium |
| **2** | B | Fix page_views insert (remove bad columns) | Trivial |
| **3** | C | Fix signup deal-attribution (add migration or use existing field) | Small |
| **4** | E | Wire AI generation to new form fields | Small (after A) |
| **5** | H | Add editor section for LP content (even a simple textarea group) | Medium |
| **6** | D | Integrate LandingPageAnalytics into admin UI | Small |
| **7** | F | Fix calendar URL per-presenter | Small |
| **8** | J | Add view deduplication | Small |
| **9** | M | Fix visible_to_buyer_types label inversion | Trivial |
| **10** | L | Evaluate if signup links should be relative | Decision |
| **11** | N-T | Code cleanup & quality fixes | Low priority |

---

## Files Requiring Changes (Ordered by Priority)

### Must-fix for landing pages to work:
1. `src/components/admin/ImprovedListingEditor.tsx` — Add 12 fields to Zod schema
2. `src/hooks/admin/listings/use-robust-listing-creation.ts` — Add 12 fields to DB insert
3. `src/pages/DealLandingPage/index.tsx` — Fix page_views insert columns
4. `src/pages/Signup/useSignupSubmit.ts` — Fix signup_metadata to use existing column or add migration

### Should-fix for full functionality:
5. `src/hooks/admin/listings/use-generate-listing-content.ts` — Wire AI output to new form fields
6. New editor section component for LP content fields
7. Integrate `LandingPageAnalytics` into admin listing views
8. `src/pages/DealLandingPage/components/DealRequestForm.tsx` — Dynamic calendar URL
9. `src/pages/DealLandingPage/components/DealSidebar.tsx` — Calendar URL from DB

### Nice-to-have:
10. Remove 9 dead editor section components
11. Remove `ListingForm.tsx` wrapper
12. Fix type casting in editor
13. Improve anonymizer title diversity
14. Add international phone regex to anonymizer
